<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Prometheus - Warner&#039;s Wiki</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Warner&#039;s Wiki"><meta name="msapplication-TileImage" content="/logo.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Warner&#039;s Wiki"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Prometheus是一个开源的云原生监控系统和时间序列数据库。"><meta property="og:type" content="blog"><meta property="og:title" content="Prometheus"><meta property="og:url" content="https://warnerchen.github.io/2024/02/18/prometheus/"><meta property="og:site_name" content="Warner&#039;s Wiki"><meta property="og:description" content="Prometheus是一个开源的云原生监控系统和时间序列数据库。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/prometheus_logo.jpg"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/Prometheus%E6%9E%B6%E6%9E%84.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/Prometheus%E5%AE%89%E8%A3%85%E4%B8%80.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/node_exporter%E6%B5%8B%E8%AF%95.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97cpu%E4%BD%BF%E7%94%A8%E7%8E%87%E4%B8%80.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97cpu%E4%BD%BF%E7%94%A8%E7%8E%87%E4%BA%8C.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E7%8E%87.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/rate%E5%87%BD%E6%95%B0%E4%B8%80.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/rate%E5%87%BD%E6%95%B0%E4%BA%8C.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/topk%E5%87%BD%E6%95%B0%E4%B8%80.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/%E6%B7%BB%E5%8A%A0pushgateway.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BC%96%E5%86%99%E8%84%9A%E6%9C%AC.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E4%B8%80.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E4%BA%8C.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E4%B8%89.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E5%9B%9B.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/JSON%E5%A4%87%E4%BB%BD.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/JSON%E8%BF%98%E5%8E%9F.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%B8%80.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%BA%8C.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%B8%89.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E5%9B%9B.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%BA%94.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E5%85%AD.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97%E7%A1%AC%E7%9B%98%E4%BD%BF%E7%94%A8%E7%8E%87%E4%B8%80.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97%E7%A1%AC%E7%9B%98%E4%BD%BF%E7%94%A8%E7%8E%87%E4%BA%8C.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/%E7%9B%91%E6%8E%A7IO%E7%8A%B6%E6%80%81.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/%E7%9B%91%E6%8E%A7%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E4%BD%BF%E7%94%A8%E7%8E%87.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/%E7%BD%91%E7%BB%9C%E5%BB%B6%E8%BF%9F%E5%92%8C%E4%B8%A2%E5%8C%85%E7%8E%87%E7%9B%91%E6%8E%A7.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%B8%80.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%BA%8C.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%B8%89.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%9B%9B.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%BA%94.png"><meta property="og:image" content="https://warnerchen.github.io/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%85%AD.png"><meta property="article:published_time" content="2024-02-18T08:06:41.000Z"><meta property="article:modified_time" content="2025-05-29T06:41:25.112Z"><meta property="article:author" content="Warner Chen"><meta property="article:tag" content="prometheus"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://warnerchen.github.io/2024/02/18/prometheus/prometheus_logo.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://warnerchen.github.io/2024/02/18/prometheus/"},"headline":"Prometheus","image":["https://warnerchen.github.io/2024/02/18/prometheus/prometheus_logo.jpg","https://warnerchen.github.io/2024/02/18/prometheus/Prometheus%E6%9E%B6%E6%9E%84.png","https://warnerchen.github.io/2024/02/18/prometheus/Prometheus%E5%AE%89%E8%A3%85%E4%B8%80.png","https://warnerchen.github.io/2024/02/18/prometheus/node_exporter%E6%B5%8B%E8%AF%95.png","https://warnerchen.github.io/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97cpu%E4%BD%BF%E7%94%A8%E7%8E%87%E4%B8%80.png","https://warnerchen.github.io/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97cpu%E4%BD%BF%E7%94%A8%E7%8E%87%E4%BA%8C.png","https://warnerchen.github.io/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E7%8E%87.png","https://warnerchen.github.io/2024/02/18/prometheus/rate%E5%87%BD%E6%95%B0%E4%B8%80.png","https://warnerchen.github.io/2024/02/18/prometheus/rate%E5%87%BD%E6%95%B0%E4%BA%8C.png","https://warnerchen.github.io/2024/02/18/prometheus/topk%E5%87%BD%E6%95%B0%E4%B8%80.png","https://warnerchen.github.io/2024/02/18/prometheus/%E6%B7%BB%E5%8A%A0pushgateway.png","https://warnerchen.github.io/2024/02/18/prometheus/%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BC%96%E5%86%99%E8%84%9A%E6%9C%AC.png","https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E4%B8%80.png","https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E4%BA%8C.png","https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E4%B8%89.png","https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E5%9B%9B.png","https://warnerchen.github.io/2024/02/18/prometheus/JSON%E5%A4%87%E4%BB%BD.png","https://warnerchen.github.io/2024/02/18/prometheus/JSON%E8%BF%98%E5%8E%9F.png","https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%B8%80.png","https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%BA%8C.png","https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%B8%89.png","https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E5%9B%9B.png","https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%BA%94.png","https://warnerchen.github.io/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E5%85%AD.png","https://warnerchen.github.io/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97%E7%A1%AC%E7%9B%98%E4%BD%BF%E7%94%A8%E7%8E%87%E4%B8%80.png","https://warnerchen.github.io/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97%E7%A1%AC%E7%9B%98%E4%BD%BF%E7%94%A8%E7%8E%87%E4%BA%8C.png","https://warnerchen.github.io/2024/02/18/prometheus/%E7%9B%91%E6%8E%A7IO%E7%8A%B6%E6%80%81.png","https://warnerchen.github.io/2024/02/18/prometheus/%E7%9B%91%E6%8E%A7%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E4%BD%BF%E7%94%A8%E7%8E%87.png","https://warnerchen.github.io/2024/02/18/prometheus/%E7%BD%91%E7%BB%9C%E5%BB%B6%E8%BF%9F%E5%92%8C%E4%B8%A2%E5%8C%85%E7%8E%87%E7%9B%91%E6%8E%A7.png","https://warnerchen.github.io/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%B8%80.png","https://warnerchen.github.io/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%BA%8C.png","https://warnerchen.github.io/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%B8%89.png","https://warnerchen.github.io/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%9B%9B.png","https://warnerchen.github.io/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%BA%94.png","https://warnerchen.github.io/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%85%AD.png"],"datePublished":"2024-02-18T08:06:41.000Z","dateModified":"2025-05-29T06:41:25.112Z","author":{"@type":"Person","name":"Warner Chen"},"publisher":{"@type":"Organization","name":"Warner's Wiki","logo":{"@type":"ImageObject","url":"https://warnerchen.github.io/logo.jpg"}},"description":"Prometheus是一个开源的云原生监控系统和时间序列数据库。"}</script><link rel="canonical" href="https://warnerchen.github.io/2024/02/18/prometheus/"><link rel="icon" href="/logo.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/logo.jpg" alt="Warner&#039;s Wiki" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/warnerchen/"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-02-18T08:06:41.000Z" title="2/18/2024, 4:06:41 PM">2024-02-18</time></span><span class="level-item">Updated&nbsp;<time dateTime="2025-05-29T06:41:25.112Z" title="5/29/2025, 2:41:25 PM">2025-05-29</time></span><span class="level-item">30 minutes read (About 4432 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Prometheus</h1><div class="content"><p><img src="/2024/02/18/prometheus/prometheus_logo.jpg"></p>
<p>Prometheus是一个开源的<strong>云原生</strong>监控系统和时间序列数据库。</p>
<span id="more"></span>

<h2 id="一、Prometheus概述"><a href="#一、Prometheus概述" class="headerlink" title="一、Prometheus概述"></a>一、Prometheus概述</h2><p>Prometheus 作为新一代的云原生监控系统，目前已经有超过 650+位贡献者参与到 Prometheus 的研发工作上，并且超过 120+项的第三方集成。</p>
<h3 id="1-1-Prometheus的优点"><a href="#1-1-Prometheus的优点" class="headerlink" title="1.1 Prometheus的优点"></a>1.1 Prometheus的优点</h3><ol>
<li><strong>提供多维度数据模型和灵活的查询方式</strong>，通过将监控指标关联多个 tag，来将监控数据进行任意维度的组合，并且提供简单的 PromQL 查询方式，还提供 HTTP 查询接口，可以很方便地结合 Grafana 等 GUI 组件展示数据。</li>
<li>在不依赖外部存储的情况下，<strong>支持服务器节点的本地存储</strong>，通过 Prometheus 自带的时序数据库，可以完成每秒千万级的数据存储；不仅如此，在保存大量历史数据的场景中，Prometheus 可以对接第三方时序数据库和 OpenTSDB 等。</li>
<li><strong>定义了开放指标数据标准</strong>，以基于 HTTP 的 Pull 方式采集时序数据，只有实现了 Prometheus 监控数据才可以被 Prometheus 采集、汇总、并支持 Push 方式向中间网关推送时序列数据，能更加灵活地应对多种监控场景。</li>
<li><strong>支持通过静态文件配置和动态发现机制发现监控对象，自动完成数据采集</strong>。</li>
<li>Prometheus 目前已经支持 Kubernetes、etcd、Consul 等多种服务发现机制。<strong>易于维护</strong>，可以通过二进制文件直接启动，并且提供了容器化部署镜像。</li>
<li><strong>支持数据的分区采样和联邦部署，支持大规模集群监控。</strong></li>
</ol>
<h3 id="1-2-Prometheus基本组件"><a href="#1-2-Prometheus基本组件" class="headerlink" title="1.2 Prometheus基本组件"></a>1.2 Prometheus基本组件</h3><ol>
<li>Prometheus Server：是 Prometheus 组件中的核心部分，负责实现对监控数据的获取，存储以及查询。收集到的数据统称为<strong>metrics</strong>。</li>
<li>Push Gateway：当网络需求无法直接满足时，就可以利用 Push Gateway 来进行中转。可以通过 Push Gateway 将内部网络的监控数据主动 <strong>Push</strong> 到 Gateway 当中。而 Prometheus Server 则可以采用同样 <strong>Pull</strong> 的方式从 Push Gateway 中获取到监控数据。</li>
<li>Exporter：主要用来采集数据，并通过 HTTP 服务的形式暴露给 Prometheus Server，Prometheus Server 通过访问该 Exporter 提供的接口，即可获取到需要采集的监控数据。</li>
<li>Alert manager：管理告警，主要是负责实现报警功能。现在grafana也能实现报警功能，所以也慢慢被取代。</li>
</ol>
<p><img src="/2024/02/18/prometheus/Prometheus%E6%9E%B6%E6%9E%84.png"></p>
<h3 id="1-3-Prometheus数据类型"><a href="#1-3-Prometheus数据类型" class="headerlink" title="1.3 Prometheus数据类型"></a>1.3 Prometheus数据类型</h3><ol>
<li>Counter（计数器类型）：Counter类型的指标的工作方式和计数器一样，只增不减（除非系统发生了重置）。</li>
<li>Gauge（仪表盘类型）：Gauge是可增可减的指标类，可以用于反应当前应用的状态。</li>
<li>Histogram（直方图类型）：主要用于表示一段时间范围内对数据进行采样（通常是请求持续时间或响应大小），并能够对其指定区间以及总数进行统计，通常它采集的数据展示为直方图。</li>
<li>Summary（摘要类型）：主要用于表示一段时间内数据采样结果（通常是请求持续时间或响应大小）。</li>
</ol>
<h2 id="二、Prometheus安装"><a href="#二、Prometheus安装" class="headerlink" title="二、Prometheus安装"></a>二、Prometheus安装</h2><h3 id="2-1-Prometheus-server安装"><a href="#2-1-Prometheus-server安装" class="headerlink" title="2.1 Prometheus server安装"></a>2.1 Prometheus server安装</h3><ol>
<li>Prometheus安装较为简单，下载解压即可</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.26.0-rc.0/prometheus-2.26.0-rc.0.linux-amd64.tar.gz</span><br><span class="line">tar -xf prometheus-2.26.0-rc.0.linux-amd64.tar.gz</span><br><span class="line">mv prometheus-2.26.0-rc.0.linux-amd64 prometheus</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>prometheus.yml配置文件</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span>     <span class="string">15s</span> <span class="comment"># 设置抓取间隔，默认为1分钟</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span> <span class="comment"># 估算规则的默认周期，每15秒计算一次规则，默认1分钟</span></span><br><span class="line">  <span class="comment"># scrape_timeout # 默认抓取超时，默认为10s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 报警配置</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="comment"># - alertmanager:9093</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 规则文件列表，使用&#x27;evaluation_interval&#x27; 参数去抓取</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="comment"># - &quot;first_rules.yml&quot;</span></span><br><span class="line">  <span class="comment"># - &quot;second_rules.yml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 抓取配置列表</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># 任务名称</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line">    <span class="comment"># 要被监控的客户端</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>创建Prometheus的用户及数据存储目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">groupadd prometheus</span><br><span class="line">useradd -g prometheus -s /sbin/nologin prometheus</span><br><span class="line">mkdir /root/prometheus/data</span><br><span class="line">chown -R prometheus:prometheus /root/prometheus</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Prometheus的启动很简单，只需要直接启动解压目录的二进制文件Prometheus即可，但是为了更加方便对Prometheus进行管理，这里编写脚本或者使用screen工具来进行启动</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /root/prometheus/start.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">prometheus_dir=/root/prometheus</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">&#123;prometheus_dir&#125;/prometheus --config.file=<span class="variable">$&#123;prometheus_dir&#125;</span>/prometheus.yml --storage.tsdb.path=<span class="variable">$&#123;prometheus_dir&#125;</span>/data --storage.tsdb.retention.time=24h --web.enable-lifecycle --storage.tsdb.no-lockfile</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--config.file:指定配置文件路径</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--storage.tsdb.path:指定tsdb路径</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--storage.tsdb.retention.time:指定数据存储时间</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--web.enable-lifecycle:类似nginx的reload功能</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--storage.tsdb.no-lockfile:如果用k8s的deployment管理需加此项</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>启动Prometheus后访问</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">nohup</span>英文全称no hang up（不挂起），用于在系统后台不挂断地运行命令，退出终端不会影响程序的运行。</span></span><br><span class="line">nohup sh start.sh 2&gt;&amp;1 &gt; prometheus.log</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/Prometheus%E5%AE%89%E8%A3%85%E4%B8%80.png"></p>
<ol start="6">
<li>用screen工具进行启动</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yum -y install screen</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入后台</span></span><br><span class="line">screen</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行脚本</span></span><br><span class="line">/root/prometheus/prometheus --config.file=/root/prometheus/prometheus.yml --storage.tsdb.path=/root/prometheus/data --storage.tsdb.retention.time=24h --web.enable-lifecycle --storage.tsdb.no-lockfile</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输入CTRL + A + D撤回前台</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看后台运行的脚本</span></span><br><span class="line">screen -ls</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">返回后台</span></span><br><span class="line">screen -r 后台id</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除后台</span></span><br><span class="line">screen -S 后台id -X quit</span><br></pre></td></tr></table></figure>

<h3 id="2-2-node-exporter安装"><a href="#2-2-node-exporter安装" class="headerlink" title="2.2 node exporter安装"></a>2.2 node exporter安装</h3><p>在Prometheus架构中，exporter是负责收集数据并将信息汇报给Prometheus Server的组件。官方提供了node_exporter内置了对主机系统的基础监控。</p>
<ol>
<li>下载node exporter</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/node_exporter/releases/download/v1.1.2/node_exporter-1.1.2.linux-amd64.tar.gz</span><br><span class="line">tar -xf node_exporter-1.1.2.linux-amd64.tar.gz</span><br><span class="line">mv node_exporter-1.1.2.linux-amd64.tar.gz node_exporter</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在prometheus.yml中添加被监控主机</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>,<span class="string">&#x27;localhost:9100&#x27;</span>]</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>后台启动exporter和重启prometheus</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">screen</span><br><span class="line">./root/node_exporter/node_exporter</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>通过curl命令获取收集到的数据key</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9100/metrics</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>用其中的一个key在Prometheus测试是否被监控</li>
</ol>
<p><img src="/2024/02/18/prometheus/node_exporter%E6%B5%8B%E8%AF%95.png"></p>
<h2 id="三、Prometheus命令行的使用"><a href="#三、Prometheus命令行的使用" class="headerlink" title="三、Prometheus命令行的使用"></a>三、Prometheus命令行的使用</h2><h3 id="3-1-计算cpu使用率"><a href="#3-1-计算cpu使用率" class="headerlink" title="3.1 计算cpu使用率"></a>3.1 计算cpu使用率</h3><p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97cpu%E4%BD%BF%E7%94%A8%E7%8E%87%E4%B8%80.png"></p>
<p>通过上图可以知道，linux的cpu使用是分为很多种状态的，例如用户态user，空闲态idle。</p>
<p>要计算cpu的使用率有两种粗略的公式：</p>
<ol>
<li>除去idle状态的所有cpu状态时间之和 &#x2F; cpu时间总和</li>
<li>100% - （idle状态 &#x2F; cpu时间总和）</li>
</ol>
<p>但这两种方式都存在两个问题：</p>
<ol>
<li>如何计算某一时间段的cpu使用率？例如精确到每一分钟。</li>
<li>实际工作中cpu大多数都是多核的，node exporter截取到的数据精确到了每个核，如何监控所有核加起来的数据？</li>
</ol>
<p>Prometheus提供了许多的函数，其中 increase 和 sum 就很好的解决了以上两个问题。</p>
<ol>
<li>提取cpu的key，即node_cpu_seconds_total</li>
<li>把idle空闲时间和总时间过滤出来，在Prometheus中使用{}进行过滤</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>使用increase函数取一分钟内的增量</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m])</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>使用sum函数将每个核的数整合起来</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m]))</span><br></pre></td></tr></table></figure>

<p>到这里又出现一个问题，sum函数会将所有数据整合起来，不光将一台机器的所有cpu加到一起，也将所有机器的cpu都加到了一起，最终显示的是集群cpu的总平均值，by(instance)可以解决这个问题。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m])) by(instance)</span><br></pre></td></tr></table></figure>

<p>这样就得到了空闲时cpu的数据了，用上边第一个公式即可得到单台主机cpu在一分钟内的使用率。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(1 - ((sum(increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m])) by(instance)) / (sum(increase(node_cpu_seconds_total[1m])) by(instance)))) * 100</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97cpu%E4%BD%BF%E7%94%A8%E7%8E%87%E4%BA%8C.png"></p>
<h3 id="3-2-计算内存使用率"><a href="#3-2-计算内存使用率" class="headerlink" title="3.2 计算内存使用率"></a>3.2 计算内存使用率</h3><p>内存使用率公式为 &#x3D; (available &#x2F; total) * 100</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E7%8E%87.png"></p>
<h3 id="3-3-rate函数"><a href="#3-3-rate函数" class="headerlink" title="3.3 rate函数"></a>3.3 rate函数</h3><p>rate函数是专门搭配counter类型数据使用的函数，功能是按照设置的一个时间段，取counter在这个时间段中平均每秒的增量。</p>
<p>举个栗子，假设我们要取ens33这个网卡在一分钟内字节的接受数量，假如一分钟内接收到的是1000bytes，那么平均每秒接收到就是1000bytes &#x2F; 1m * 60s ≈ 16bytes&#x2F;s。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(node_network_receive_bytes_total&#123;device=&#x27;ens33&#x27;&#125;[1m])</span><br></pre></td></tr></table></figure>

<p>如果是五分钟的话即为5000bytes &#x2F; 5m * 60s ≈ 16bytes&#x2F;s，结果是一样的，但曲线图就不一样了，上图为一分钟，下图为五分钟，因为五分钟的密度要更底，所以可以看到五分钟的曲线图更加平缓。</p>
<p><img src="/2024/02/18/prometheus/rate%E5%87%BD%E6%95%B0%E4%B8%80.png"></p>
<p><img src="/2024/02/18/prometheus/rate%E5%87%BD%E6%95%B0%E4%BA%8C.png"></p>
<p>rate和increase的概念有些类似，但rate取的是一段时间增量的平均每秒数量，increase取的是一段时间增量的总量，即：</p>
<ul>
<li>rate(1m)：总量 &#x2F; 60s</li>
<li>increase(1m)：总量</li>
</ul>
<h3 id="3-4-sum函数"><a href="#3-4-sum函数" class="headerlink" title="3.4 sum函数"></a>3.4 sum函数</h3><p>sum函数就是将收到的数据全部进行整合。</p>
<p>假如一个集群里有20台服务器，分别为5台web服务器，10台db服务器，还有5台其他服务的服务器，这时候sum就可以分为三条曲线来代表不同功能服务器的总和数据。</p>
<h3 id="3-5-topk函数"><a href="#3-5-topk函数" class="headerlink" title="3.5 topk函数"></a>3.5 topk函数</h3><p>topk函数的作用就是取前几位的最高值。</p>
<p><img src="/2024/02/18/prometheus/topk%E5%87%BD%E6%95%B0%E4%B8%80.png"></p>
<h3 id="3-6-count函数"><a href="#3-6-count函数" class="headerlink" title="3.6 count函数"></a>3.6 count函数</h3><p>count函数的作用是把符合条件的数值进行整合。</p>
<p>假如我们要查看集群中cpu使用率超过80%的主机数量的话</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">count((1 - ((sum(increase(node_cpu_seconds_total&#123;mode=&#x27;idle&#x27;&#125;[1m])) by(instance)) / (sum(increase(node_cpu_seconds_total[1m])) by(instance)))) * 100 &gt; 80)</span><br></pre></td></tr></table></figure>



<h2 id="四、Push-gateway"><a href="#四、Push-gateway" class="headerlink" title="四、Push gateway"></a>四、Push gateway</h2><p>Push gateway实际上就是一种被动推送数据的方式，与exporter主动获取不同。</p>
<h3 id="4-1-Push-gateway安装"><a href="#4-1-Push-gateway安装" class="headerlink" title="4.1 Push gateway安装"></a>4.1 Push gateway安装</h3><ol>
<li>下载安装Push gateway</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/pushgateway/releases/download/v1.4.0/pushgateway-1.4.0.linux-amd64.tar.gz</span><br><span class="line">tar -xf pushgateway-1.4.0.linux-amd64.tar.gz</span><br><span class="line">mv pushgateway-1.4.0.linux-amd64 pushgateway</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>后台运行Push gateway</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">screen</span><br><span class="line">./root/pushgateway/pushgateway</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在prometheus.yml中加上</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &#x27;pushgateway&#x27;</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets: [&#x27;localhost:9091&#x27;]</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E6%B7%BB%E5%8A%A0pushgateway.png"></p>
<h3 id="4-2-自定义编写脚本"><a href="#4-2-自定义编写脚本" class="headerlink" title="4.2 自定义编写脚本"></a>4.2 自定义编写脚本</h3><p>由于Push gateway自己本身是没有任何抓取数据的功能的，所以用户需要自行编写脚本来抓取数据。</p>
<p>举个例子：编写脚本抓取 TCP waiting_connection 的数量</p>
<ol>
<li>编写自定义脚本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取监控主机名</span></span><br><span class="line">instance_name=`hostname -f | cut -d&#x27;.&#x27; -f1`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果主机名为localhost，则退出</span></span><br><span class="line">if [ $instance_name == &quot;localhost&quot; ]</span><br><span class="line">then</span><br><span class="line">        echo &quot;不能监控主机名为localhost的主机&quot;</span><br><span class="line">        exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取TCP CONNECTED数量</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">抓取TCP CONNECTED数量，定义为一个新key</span></span><br><span class="line">lable_tcp_connected=&quot;count_netstat_connected_connections&quot;</span><br><span class="line">count_netstat_connected_connections=`netstat -an | grep &#x27;CONNECTED&#x27; | wc -l`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上传至pushgateway</span></span><br><span class="line">echo &quot;$lable_tcp_connected $count_netstat_connected_connections&quot; | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该脚本是通过post的方式将key推送给pushgateway</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http://localhost:9091 即推送给哪台pushgateway主机</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">job/pushgateway 即推送给prometheus.yml中定义的job为pushgateway的主机</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">instance/<span class="variable">$instance_name</span> 推送后显示的主机名</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>因为脚本都是运行一次后就结束了，可以配合crontab反复运行</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">每分钟执行一次脚本</span></span><br><span class="line">* * * * * sh /root/pushgateway/node_exporter_shell.sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">每10s执行一次脚本</span></span><br><span class="line">* * * * * sh /root/pushgateway/node_exporter_shell.sh</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BC%96%E5%86%99%E8%84%9A%E6%9C%AC.png"></p>
<h3 id="4-3-编写抓取ping丢包和延迟时间数据"><a href="#4-3-编写抓取ping丢包和延迟时间数据" class="headerlink" title="4.3 编写抓取ping丢包和延迟时间数据"></a>4.3 编写抓取ping丢包和延迟时间数据</h3><p>在node_exporter_shell.sh中加入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取ping某网站丢包率和延迟时间</span></span><br><span class="line"></span><br><span class="line">site_address=&quot;www.baidu.com&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取丢包率和延迟时间，定义为两个新key</span></span><br><span class="line">lable_ping_packet_loss=&quot;ping_packet_loss&quot;</span><br><span class="line">ping_packet_loss_test=`ping -c3 $site_address | awk &#x27;NR==7&#123;print $6&#125;&#x27;`</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">字符串截取，%?为去除最后一个字符</span></span><br><span class="line">ping_packet_loss=`echo $&#123;ping_packet_loss_test%?&#125;`</span><br><span class="line"></span><br><span class="line">lable_ping_time=&quot;ping_time&quot;</span><br><span class="line">ping_time_test=`ping -c3 $site_address | awk &#x27;NR==7&#123;print $10&#125;&#x27;`</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">字符串截取，%??为去除最后两个字符</span></span><br><span class="line">ping_time=`echo $&#123;ping_time_test%??&#125;`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上传至push_ping_timegateway</span></span><br><span class="line">echo &quot;$lable_ping_packet_loss $ping_packet_loss&quot; | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name</span><br><span class="line"></span><br><span class="line">echo &quot;$lable_ping_time $ping_time&quot; | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br></pre></td></tr></table></figure>



<h2 id="五、Grafana的使用"><a href="#五、Grafana的使用" class="headerlink" title="五、Grafana的使用"></a>五、Grafana的使用</h2><p>Grafana是一款用Go语言开发的开源数据可视化工具，可以做数据监控和数据统计，带有告警功能。</p>
<h3 id="5-1-Grafana安装"><a href="#5-1-Grafana安装" class="headerlink" title="5.1 Grafana安装"></a>5.1 Grafana安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.grafana.com/oss/release/grafana-7.5.1-1.x86_64.rpm</span><br><span class="line">yum -y install grafana-7.5.1-1.x86_64.rpm</span><br><span class="line">systemctl start grafana-server</span><br><span class="line">systemctl enable grafana-server</span><br></pre></td></tr></table></figure>

<h3 id="5-2-设置数据源"><a href="#5-2-设置数据源" class="headerlink" title="5.2 设置数据源"></a>5.2 设置数据源</h3><ol>
<li>Grafana -&gt; Configuration -&gt; Date Sources -&gt; Prometheus</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E4%B8%80.png"></p>
<ol start="2">
<li>New dashboard</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E4%BA%8C.png"></p>
<ol start="3">
<li>添加一个监控和CPU内存使用率的仪表盘</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E4%B8%89.png"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%89%E8%A3%85%E5%9B%9B.png"></p>
<h3 id="5-3-json备份和还原"><a href="#5-3-json备份和还原" class="headerlink" title="5.3 json备份和还原"></a>5.3 json备份和还原</h3><ol>
<li>备份：dashboard -&gt; Settings -&gt; JSON Model，将里面内容保存为json文件</li>
</ol>
<p><img src="/2024/02/18/prometheus/JSON%E5%A4%87%E4%BB%BD.png"></p>
<ol start="2">
<li>恢复：Create -&gt; import</li>
</ol>
<p><img src="/2024/02/18/prometheus/JSON%E8%BF%98%E5%8E%9F.png"></p>
<h3 id="5-4-Grafana实现报警功能"><a href="#5-4-Grafana实现报警功能" class="headerlink" title="5.4 Grafana实现报警功能"></a>5.4 Grafana实现报警功能</h3><ol>
<li>配置Grafana文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装依赖和图形显示插件</span></span><br><span class="line">yum -y install libatk-bridge* libXss* libgtk*</span><br><span class="line">grafana-cli plugins install grafana-image-renderer</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改配置</span></span><br><span class="line">vim /etc/grafana/grafana.ini</span><br><span class="line">enabled = true</span><br><span class="line">host = smtp.163.com:25</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发送报警邮件的邮箱</span></span><br><span class="line">user = chenqiming13@163.com</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">授权码</span></span><br><span class="line">password = QXQALYMTRYRWIOOS</span><br><span class="line">skip_verify = true</span><br><span class="line">from_address = chenqiming13@163.com</span><br><span class="line">from_name = Grafana</span><br><span class="line">systemctl restart grafana-server</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建报警规则</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%B8%80.png"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%BA%8C.png"></p>
<ol start="3">
<li>针对具体监控项，设置发送邮件阈值等，这里设置为发现超过阈值起5分钟后触发报警</li>
</ol>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%B8%89.png"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E5%9B%9B.png"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E4%BA%94.png"></p>
<p><img src="/2024/02/18/prometheus/Grafana%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%8A%9F%E8%83%BD%E5%85%AD.png"></p>
<p>![](Grafana实现报警功能七.png</p>
<h2 id="六、Prometheus-Grafana实际案例"><a href="#六、Prometheus-Grafana实际案例" class="headerlink" title="六、Prometheus + Grafana实际案例"></a>六、Prometheus + Grafana实际案例</h2><h3 id="6-1-predict-linear函数实现硬盘监控"><a href="#6-1-predict-linear函数实现硬盘监控" class="headerlink" title="6.1 predict_linear函数实现硬盘监控"></a>6.1 predict_linear函数实现硬盘监控</h3><p>硬盘使用率公式为：（（总容量 - 剩余容量）&#x2F;  总容量）* 100，在Prometheus中表示为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((node_filesystem_size_bytes - node_filesystem_free_bytes) / node_filesystem_size_bytes) * 100</span><br></pre></td></tr></table></figure>

<p>通过df -m可以看出计算出来的值是正确的</p>
<p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97%E7%A1%AC%E7%9B%98%E4%BD%BF%E7%94%A8%E7%8E%87%E4%B8%80.png"></p>
<p>Prometheus提供了一个predict_linear函数可以预计多长时间磁盘爆满，例如当前这1个小时的磁盘可用率急剧下降，这种情况可能导致磁盘很快被写满，这时可以使用该函数，用当前1小时的数据去预测未来几个小时的状态，实现提前报警。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该式子表示用当前1小时的值来预测未来4小时后如果根目录下容量小于0则触发报警</span></span><br><span class="line">predict_linear(node_filesystem_free_bytes &#123;mountpoint =&quot;/&quot;&#125;[1h], 4*3600) &lt; 0</span><br></pre></td></tr></table></figure>

<p>在Grafana添加监控硬盘使用率和预测硬盘使用率的仪表盘</p>
<p><img src="/2024/02/18/prometheus/%E8%AE%A1%E7%AE%97%E7%A1%AC%E7%9B%98%E4%BD%BF%E7%94%A8%E7%8E%87%E4%BA%8C.png"></p>
<h3 id="6-2-监控硬盘IO"><a href="#6-2-监控硬盘IO" class="headerlink" title="6.2 监控硬盘IO"></a>6.2 监控硬盘IO</h3><p>公式为：（读取时间 &#x2F; 写入时间）&#x2F; 1024 &#x2F; 1024，用rate函数取一分钟内读和写的字节增长率来计算，用Prometheus表示为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((rate(node_disk_read_bytes_total[1m]) + rate(node_disk_written_bytes_total[1m])) / 1024 / 1024) &gt; 0</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E7%9B%91%E6%8E%A7IO%E7%8A%B6%E6%80%81.png"></p>
<h3 id="6-3-监控TCP-WAIT状态的数量"><a href="#6-3-监控TCP-WAIT状态的数量" class="headerlink" title="6.3 监控TCP_WAIT状态的数量"></a>6.3 监控TCP_WAIT状态的数量</h3><p>在被监控主机上编写监控脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取监控主机名</span></span><br><span class="line">instance_name=`hostname -f | cut -d&#x27;.&#x27; -f1`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果主机名为localhost，则退出</span></span><br><span class="line">if [ $instance_name == &quot;localhost&quot; ]</span><br><span class="line">then</span><br><span class="line">        echo &quot;不能监控主机名为localhost的主机&quot;</span><br><span class="line">        exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取TCP WAIT数量</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">抓取TCP WAIT数量，定义为一个新key</span></span><br><span class="line">lable_tcp_wait=&quot;count_netstat_wait_connections&quot;</span><br><span class="line">count_netstat_wait_connections=`netstat -an | grep &#x27;WAIT&#x27; | wc -l`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上传至pushgateway</span></span><br><span class="line">echo &quot;$lable_tcp_wait $count_netstat_wait_connections&quot; | curl --data-binary @- http://localhost:9091/metrics/job/pushgateway/instance/$instance_name</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">---</span></span><br></pre></td></tr></table></figure>

<h3 id="6-4-监控文件描述符使用率"><a href="#6-4-监控文件描述符使用率" class="headerlink" title="6.4 监控文件描述符使用率"></a>6.4 监控文件描述符使用率</h3><p>在linux中，每当进程打开一个文件时，系统就会为其分配一个唯一的整型文件描述符，用来标识这个文件，每个进程默认打开的文件描述符有三个，分别为标准输入、标准输出、标准错误，即stdin、stout、steer，用文件描述符来表示为0、1、2。</p>
<p>用命令可以查看目前系统的最大文件描述符限制，一般默认设置是1024。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ulimit -n</span><br></pre></td></tr></table></figure>

<p>文件描述符使用率公式为：（已分配的文件描述符数量 &#x2F; 最大文件描述符数量）* 100，在Prometheus中则表示为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(node_filefd_allocated / node_filefd_maximum) * 100</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E7%9B%91%E6%8E%A7%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E4%BD%BF%E7%94%A8%E7%8E%87.png"></p>
<h3 id="6-5-网络延迟和丢包率监控"><a href="#6-5-网络延迟和丢包率监控" class="headerlink" title="6.5 网络延迟和丢包率监控"></a>6.5 网络延迟和丢包率监控</h3><p>前面我们采用的都是简单的ping + ip地址来进行测试，实际上这样测试发出去的icmp数据包是非常小的，只适合用来测试网络是否连通，因此用以下命令来进行优化：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ping -q ip地址 -s 500 -W 1000 -c 100</span><br><span class="line">-q:不显示指令执行过程，开头和结尾的相关信息除外。</span><br><span class="line">-s:设置数据包的大小。</span><br><span class="line">-W:在等待 timeout 秒后开始执行。</span><br><span class="line">-c:设置完成要求回应的次数。</span><br></pre></td></tr></table></figure>

<p><img src="/2024/02/18/prometheus/%E7%BD%91%E7%BB%9C%E5%BB%B6%E8%BF%9F%E5%92%8C%E4%B8%A2%E5%8C%85%E7%8E%87%E7%9B%91%E6%8E%A7.png"></p>
<h3 id="6-6-使用Pageduty实现报警"><a href="#6-6-使用Pageduty实现报警" class="headerlink" title="6.6 使用Pageduty实现报警"></a>6.6 使用Pageduty实现报警</h3><p>Pagerduty是一套付费监控报警系统，经常作为SRE&#x2F;运维人员的监控报警工具，可以和市面上常见的监控工具直接整合。</p>
<ol>
<li>创建新service</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%B8%80.png"><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%BA%8C.png"></p>
<ol start="2">
<li>在Grafana新建报警渠道，并在仪表盘中设置为Pageduty报警</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%B8%89.png"></p>
<ol start="3">
<li>设置报警信息</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%9B%9B.png"></p>
<ol start="4">
<li>查看是否收到报警</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E4%BA%94.png"></p>
<ol start="5">
<li>当问题解决可以点击已解决</li>
</ol>
<p><img src="/2024/02/18/prometheus/pateduty%E5%AE%9E%E7%8E%B0%E6%8A%A5%E8%AD%A6%E5%85%AD.png"></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Prometheus</p><p><a href="https://warnerchen.github.io/2024/02/18/prometheus/">https://warnerchen.github.io/2024/02/18/prometheus/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Warner Chen</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2024-02-18</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2025-05-29</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/prometheus/">prometheus</a></div><div class="notification is-danger">You need to set <code>install_url</code> to use ShareThis. Please set it in <code>_config.yml</code>.</div></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" href="/" target="_blank" rel="noopener" data-type="afdian"><span class="icon is-small"><i class="fas fa-charging-station"></i></span><span>Afdian.net</span></a><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>Alipay</span><span class="qrcode"><img src="/" alt="Alipay"></span></a><a class="button donate" href="/" target="_blank" rel="noopener" data-type="buymeacoffee"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>Buy me a coffee</span></a><a class="button donate" href="/" target="_blank" rel="noopener" data-type="patreon"><span class="icon is-small"><i class="fab fa-patreon"></i></span><span>Patreon</span></a><div class="notification is-danger">You forgot to set the <code>business</code> or <code>currency_code</code> for Paypal. Please set it in <code>_config.yml</code>.</div><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>Wechat</span><span class="qrcode"><img src="/" alt="Wechat"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2024/02/18/nexus/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Nexus</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2024/02/18/kubernetes/"><span class="level-item">Kubernetes</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card" id="comments"><div class="card-content"><h3 class="title is-5">Comments</h3><div class="notification is-danger">You forgot to set the <code>shortname</code> for Disqus. Please set it in <code>_config.yml</code>.</div></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://octodex.github.com/images/universetocat.png" alt="Warner Chen"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Warner Chen</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shenzhen, Guangdong, CN</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives/"><p class="title">83</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories/"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags/"><p class="title">29</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/warnerchen/" target="_blank" rel="me noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Github" href="https://github.com/warnerchen/"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#一、Prometheus概述"><span class="level-left"><span class="level-item">一、Prometheus概述</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-Prometheus的优点"><span class="level-left"><span class="level-item">1.1 Prometheus的优点</span></span></a></li><li><a class="level is-mobile" href="#1-2-Prometheus基本组件"><span class="level-left"><span class="level-item">1.2 Prometheus基本组件</span></span></a></li><li><a class="level is-mobile" href="#1-3-Prometheus数据类型"><span class="level-left"><span class="level-item">1.3 Prometheus数据类型</span></span></a></li></ul></li><li><a class="level is-mobile" href="#二、Prometheus安装"><span class="level-left"><span class="level-item">二、Prometheus安装</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-Prometheus-server安装"><span class="level-left"><span class="level-item">2.1 Prometheus server安装</span></span></a></li><li><a class="level is-mobile" href="#2-2-node-exporter安装"><span class="level-left"><span class="level-item">2.2 node exporter安装</span></span></a></li></ul></li><li><a class="level is-mobile" href="#三、Prometheus命令行的使用"><span class="level-left"><span class="level-item">三、Prometheus命令行的使用</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-计算cpu使用率"><span class="level-left"><span class="level-item">3.1 计算cpu使用率</span></span></a></li><li><a class="level is-mobile" href="#3-2-计算内存使用率"><span class="level-left"><span class="level-item">3.2 计算内存使用率</span></span></a></li><li><a class="level is-mobile" href="#3-3-rate函数"><span class="level-left"><span class="level-item">3.3 rate函数</span></span></a></li><li><a class="level is-mobile" href="#3-4-sum函数"><span class="level-left"><span class="level-item">3.4 sum函数</span></span></a></li><li><a class="level is-mobile" href="#3-5-topk函数"><span class="level-left"><span class="level-item">3.5 topk函数</span></span></a></li><li><a class="level is-mobile" href="#3-6-count函数"><span class="level-left"><span class="level-item">3.6 count函数</span></span></a></li></ul></li><li><a class="level is-mobile" href="#四、Push-gateway"><span class="level-left"><span class="level-item">四、Push gateway</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-1-Push-gateway安装"><span class="level-left"><span class="level-item">4.1 Push gateway安装</span></span></a></li><li><a class="level is-mobile" href="#4-2-自定义编写脚本"><span class="level-left"><span class="level-item">4.2 自定义编写脚本</span></span></a></li><li><a class="level is-mobile" href="#4-3-编写抓取ping丢包和延迟时间数据"><span class="level-left"><span class="level-item">4.3 编写抓取ping丢包和延迟时间数据</span></span></a></li></ul></li><li><a class="level is-mobile" href="#五、Grafana的使用"><span class="level-left"><span class="level-item">五、Grafana的使用</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#5-1-Grafana安装"><span class="level-left"><span class="level-item">5.1 Grafana安装</span></span></a></li><li><a class="level is-mobile" href="#5-2-设置数据源"><span class="level-left"><span class="level-item">5.2 设置数据源</span></span></a></li><li><a class="level is-mobile" href="#5-3-json备份和还原"><span class="level-left"><span class="level-item">5.3 json备份和还原</span></span></a></li><li><a class="level is-mobile" href="#5-4-Grafana实现报警功能"><span class="level-left"><span class="level-item">5.4 Grafana实现报警功能</span></span></a></li></ul></li><li><a class="level is-mobile" href="#六、Prometheus-Grafana实际案例"><span class="level-left"><span class="level-item">六、Prometheus + Grafana实际案例</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#6-1-predict-linear函数实现硬盘监控"><span class="level-left"><span class="level-item">6.1 predict_linear函数实现硬盘监控</span></span></a></li><li><a class="level is-mobile" href="#6-2-监控硬盘IO"><span class="level-left"><span class="level-item">6.2 监控硬盘IO</span></span></a></li><li><a class="level is-mobile" href="#6-3-监控TCP-WAIT状态的数量"><span class="level-left"><span class="level-item">6.3 监控TCP_WAIT状态的数量</span></span></a></li><li><a class="level is-mobile" href="#6-4-监控文件描述符使用率"><span class="level-left"><span class="level-item">6.4 监控文件描述符使用率</span></span></a></li><li><a class="level is-mobile" href="#6-5-网络延迟和丢包率监控"><span class="level-left"><span class="level-item">6.5 网络延迟和丢包率监控</span></span></a></li><li><a class="level is-mobile" href="#6-6-使用Pageduty实现报警"><span class="level-left"><span class="level-item">6.6 使用Pageduty实现报警</span></span></a></li></ul></li></ul></div></div><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://www.zerchin.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Zeqin</span></span><span class="level-right"><span class="level-item tag">www.zerchin.com</span></span></a></li><li><a class="level is-mobile" href="https://blog.csdn.net/Ivan_Wz?type=blog" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Lvan</span></span><span class="level-right"><span class="level-item tag">blog.csdn.net</span></span></a></li><li><a class="level is-mobile" href="https://hackmd.io/@7vxmAdNPTmmlYGSRMuvbmw" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Andy</span></span><span class="level-right"><span class="level-item tag">hackmd.io</span></span></a></li><li><a class="level is-mobile" href="https://www.xtplayer.cn/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Xiaolu</span></span><span class="level-right"><span class="level-item tag">www.xtplayer.cn</span></span></a></li><li><a class="level is-mobile" href="https://kingsd.top/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hailong</span></span><span class="level-right"><span class="level-item tag">kingsd.top</span></span></a></li><li><a class="level is-mobile" href="https://wiki.sanxian.tech/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Sanxian</span></span><span class="level-right"><span class="level-item tag">wiki.sanxian.tech</span></span></a></li><li><a class="level is-mobile" href="https://blog.kalyan.life/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Kalyan</span></span><span class="level-right"><span class="level-item tag">blog.kalyan.life</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-06-18T08:03:17.000Z">2025-06-18</time></p><p class="title"><a href="/2025/06/18/Rancher-Logging-HostTailer/">Rancher Logging HostTailer</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-06-16T11:39:07.000Z">2025-06-16</time></p><p class="title"><a href="/2025/06/16/%E8%87%AA%E5%AE%9A%E4%B9%89-RKE2-K3s-%E8%AF%81%E4%B9%A6%E6%9C%89%E6%95%88%E6%9C%9F/">自定义 RKE2/K3s 证书有效期</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-06-11T09:24:40.000Z">2025-06-11</time></p><p class="title"><a href="/2025/06/11/Prometheus-Label-Join/">Prometheus Label Join</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-06-11T07:38:11.000Z">2025-06-11</time></p><p class="title"><a href="/2025/06/11/CPU-%E7%9A%84%E4%BD%BF%E7%94%A8%E7%8E%87%E5%92%8C%E4%BD%BF%E7%94%A8%E9%87%8F/">CPU 的使用率和使用量</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-06-06T06:55:10.000Z">2025-06-06</time></p><p class="title"><a href="/2025/06/06/Fluentd-%E6%97%A5%E5%BF%97%E6%88%AA%E6%96%AD%E9%97%AE%E9%A2%98/">Fluentd 日志截断问题</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2025/06/"><span class="level-start"><span class="level-item">June 2025</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/05/"><span class="level-start"><span class="level-item">May 2025</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/04/"><span class="level-start"><span class="level-item">April 2025</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/03/"><span class="level-start"><span class="level-item">March 2025</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/02/"><span class="level-start"><span class="level-item">February 2025</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/01/"><span class="level-start"><span class="level-item">January 2025</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/12/"><span class="level-start"><span class="level-item">December 2024</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/11/"><span class="level-start"><span class="level-item">November 2024</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/10/"><span class="level-start"><span class="level-item">October 2024</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/09/"><span class="level-start"><span class="level-item">September 2024</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/08/"><span class="level-start"><span class="level-item">August 2024</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/06/"><span class="level-start"><span class="level-item">June 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/03/"><span class="level-start"><span class="level-item">March 2024</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">February 2024</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ai/"><span class="tag">ai</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ansible/"><span class="tag">ansible</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/calico/"><span class="tag">calico</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cert-manager/"><span class="tag">cert-manager</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cisco/"><span class="tag">cisco</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/container/"><span class="tag">container</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/containerd/"><span class="tag">containerd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/containers/"><span class="tag">containers</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/elasticsearch/"><span class="tag">elasticsearch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/elk/"><span class="tag">elk</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/etcd/"><span class="tag">etcd</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/fluentd/"><span class="tag">fluentd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/istio/"><span class="tag">istio</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jenkins/"><span class="tag">jenkins</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kafka/"><span class="tag">kafka</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kubernetes/"><span class="tag">kubernetes</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/metallb/"><span class="tag">metallb</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nexus/"><span class="tag">nexus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/others/"><span class="tag">others</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/prometheus/"><span class="tag">prometheus</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/suse/"><span class="tag">suse</span><span class="tag">31</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zookeeper/"><span class="tag">zookeeper</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9D%A2%E8%AF%95/"><span class="tag">面试</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%A6%96%E9%A1%B5/"><span class="tag">首页</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/logo.jpg" alt="Warner&#039;s Wiki" height="28"></a><p class="is-size-7"><span>&copy; 2025 Warner Chen</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/warnerchen/"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>